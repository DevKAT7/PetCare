@page
@model PetCare.WebApp.Pages.Appointments.CreateAppointmentModel
@{
    ViewData["Title"] = "Book Appointment";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Book Appointment</h2>
                <a asp-page="./Index" class="btn btn-outline-secondary btn-sm">Back to List</a>
            </div>
            <hr />

            <form method="post" id="appointmentForm">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <input type="hidden" asp-for="NewAppointment.AppointmentDateTime" id="FinalDateTime" />

                <h4>1. Select Veterinarian & Date</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="NewAppointment.VetId" class="form-label fw-bold">Veterinarian</label>
                        <select asp-for="NewAppointment.VetId" asp-items="Model.VetOptions" class="form-select" id="VetSelector">
                            <option value="">-- Select Veterinarian --</option>
                        </select>
                        <span asp-validation-for="NewAppointment.VetId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Date</label>
                        <input type="date" class="form-control" id="DateSelector" min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    </div>
                </div>

                <div id="TimeSlotSection" class="mb-4" style="display:none;">
                    <label class="form-label fw-bold mb-2">Available Time Slots</label>
                    <div id="SlotsContainer" class="d-flex flex-wrap gap-2">
                        <span class="text-muted fst-italic">Select a vet and date to see available times.</span>
                    </div>
                    <div class="mt-2 text-success fw-bold" id="SelectedTimeDisplay" style="display:none;">
                        Selected: <span id="TimeValue"></span>
                    </div>
                    <span asp-validation-for="NewAppointment.AppointmentDateTime" class="text-danger"></span>
                </div>

                <hr class="my-4" />

                <h4>2. Patient & Details</h4>
                <div class="mb-3">
                    <label asp-for="NewAppointment.PetId" class="form-label fw-bold">Patient (Pet)</label>
                    <select asp-for="NewAppointment.PetId" asp-items="Model.PetOptions" class="form-select">
                        <option value="">-- Select Pet --</option>
                    </select>
                    <span asp-validation-for="NewAppointment.PetId" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="NewAppointment.ReasonForVisit" class="form-label">Reason for Visit</label>
                    <input asp-for="NewAppointment.ReasonForVisit" class="form-control" placeholder="e.g. Annual Vaccination" />
                    <span asp-validation-for="NewAppointment.ReasonForVisit" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="NewAppointment.Description" class="form-label">Description (Optional)</label>
                    <textarea asp-for="NewAppointment.Description" class="form-control" rows="3"></textarea>
                </div>

                <div class="d-grid gap-2 mt-4 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg">Confirm Booking</button>
                    <a asp-page="./Index" class="btn btn-light text-muted">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () 
        {
            const vetSelect = document.getElementById('VetSelector');
            const dateSelect = document.getElementById('DateSelector');
            const slotsContainer = document.getElementById('SlotsContainer');
            const timeSlotSection = document.getElementById('TimeSlotSection');
            const finalInput = document.getElementById('FinalDateTime');
            const selectedTimeDisplay = document.getElementById('SelectedTimeDisplay');
            const timeValueSpan = document.getElementById('TimeValue');

            async function fetchSlots() 
            {
                const vetId = vetSelect.value;
                const dateVal = dateSelect.value;

                slotsContainer.innerHTML = '';
                finalInput.value = '';
                selectedTimeDisplay.style.display = 'none';

                if (!vetId || !dateVal) 
                {
                    timeSlotSection.style.display = 'none';
                    return;
                }

                timeSlotSection.style.display = 'block';
                slotsContainer.innerHTML = '<div class="spinner-border text-primary spinner-border-sm" role="status"></div> Loading...';

                try 
                {
                    const response = await fetch(`?handler=TimeSlots&vetId=${vetId}&date=${dateVal}`);
                    const slots = await response.json();

                    slotsContainer.innerHTML = '';

                    if (slots.length === 0) 
                    {
                        slotsContainer.innerHTML = '<span class="text-danger">No available slots for this date.</span>';
                        return;
                    }

                    slots.forEach(time => 
                        {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm slot-btn';
                        btn.textContent = time;

                        btn.onclick = function() 
                        {
                            document.querySelectorAll('.slot-btn').forEach(b => {
                                b.classList.remove('btn-primary', 'text-white');
                                b.classList.add('btn-outline-primary');
                            });

                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-primary', 'text-white');

                            finalInput.value = `${dateVal}T${time}:00`;

                            timeValueSpan.textContent = `${dateVal} at ${time}`;
                            selectedTimeDisplay.style.display = 'block';
                        };

                        slotsContainer.appendChild(btn);
                    });

                } 
                catch (error) 
                {
                    console.error('Error fetching slots:', error);
                    slotsContainer.innerHTML = '<span class="text-danger">Error loading schedule.</span>';
                }
            }

            vetSelect.addEventListener('change', fetchSlots);
            dateSelect.addEventListener('change', fetchSlots);
        });
    </script>
}