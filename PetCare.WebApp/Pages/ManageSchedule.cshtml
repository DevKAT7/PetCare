@page "{vetId:int}"
@model PetCare.WebApp.Pages.ManageScheduleModel
@{
    ViewData["Title"] = "Manage Schedule";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Work Schedule (@Model.VetName)</h2>
        <a href="/Admin/Vets/Index" class="btn btn-outline-secondary">Back to list</a>
    </div>
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <div class="row">
        @*LEFT COLUMN: Standard Weekly Schedule*@
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Weekly Schedule</h5>
                    <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                        <i class="bi bi-plus-lg"></i> Add
                    </button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Hours</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!Model.WeeklySchedule.Any())
                            {
                                <tr><td colspan="3" class="text-center text-muted p-3">No schedule defined.</td></tr>
                            }
                            @foreach (var item in Model.WeeklySchedule)
                            {
                                <tr>
                                    <td>@item.DayOfWeek</td>
                                    <td>
                                        @item.StartTime.ToString("HH:mm") - @item.EndTime.ToString("HH:mm")
                                    </td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary me-1"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editScheduleModal"
                                                data-id="@item.VetScheduleId"
                                                data-day="@item.DayOfWeek.ToString()"
                                                data-start="@item.StartTime.ToString("HH:mm")"
                                                data-end="@item.EndTime.ToString("HH:mm")">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteScheduleModal"
                                                data-schedule-id="@item.VetScheduleId">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        @*RIGHT COLUMN: Exceptions / Leaves*@
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Exceptions / Time Off</h5>
                    <button class="btn btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="#addExceptionModal">
                        <i class="bi bi-calendar-plus"></i> Add Exception
                    </button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Duration</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!Model.Exceptions.Any())
                            {
                                <tr><td colspan="3" class="text-center text-muted p-3">No exceptions scheduled.</td></tr>
                            }
                            @foreach (var ex in Model.Exceptions.OrderBy(e => e.ExceptionDate))
                            {
                                <tr>
                                    <td>@ex.ExceptionDate.ToString("dd.MM.yyyy")</td>
                                    <td>
                                        @if (ex.IsFullDayAbsence)
                                        {
                                            <span class="badge bg-danger">Full Day</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info text-dark">
                                                @ex.StartTime?.ToString("HH:mm") - @ex.EndTime?.ToString("HH:mm")
                                            </span>
                                        }
                                    </td>
                                    <td><small>@ex.Reason</small></td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary me-1"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editExceptionModal"
                                                data-id="@ex.ScheduleExceptionId"
                                                data-date="@ex.ExceptionDate.ToString("yyyy-MM-dd")"
                                                data-isfullday="@ex.IsFullDayAbsence.ToString().ToLower()"
                                                data-start="@ex.StartTime?.ToString("HH:mm")"
                                                data-end="@ex.EndTime?.ToString("HH:mm")"
                                                data-reason="@ex.Reason">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteExceptionModal"
                                                data-exception-id="@ex.ScheduleExceptionId">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@*Modal Add Schedule*@
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="AddSchedule">
                <div class="modal-header">
                    <h5 class="modal-title">Add Work Hours</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" asp-for="NewSchedule.VetId" value="@Model.VetId" />
                    <div class="mb-3">
                        <label class="form-label">Day of Week</label>
                        <select asp-for="NewSchedule.DayOfWeek" class="form-select"
                                asp-items="Model.WorkingDaysOptions">
                            <option value="">-- Select Day --</option>
                        </select>
                        <span asp-validation-for="NewSchedule.DayOfWeek" class="text-danger"></span>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">From</label>
                            <input type="time" asp-for="NewSchedule.StartTime" class="form-control"
                                   min="09:00" max="16:30" step="1800" />
                            <span asp-validation-for="NewSchedule.StartTime" class="text-danger"></span>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">To</label>
                            <input type="time" asp-for="NewSchedule.EndTime" class="form-control"
                                   min="09:00" max="16:30" step="1800" />
                            <span asp-validation-for="NewSchedule.EndTime" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

@*Modal Add Exception*@
<div class="modal fade" id="addExceptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="AddException">
                <div class="modal-header">
                    <h5 class="modal-title">Add Exception / Leave</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" asp-for="NewException.VetId" value="@Model.VetId" />
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" asp-for="NewException.ExceptionDate" class="form-control" />
                        <span asp-validation-for="NewException.ExceptionDate" class="text-danger"></span>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" asp-for="NewException.IsFullDayAbsence" id="isFullDayCheck" />
                        <label class="form-check-label" for="isFullDayCheck">Full day off</label>
                    </div>

                    <div id="timeInputs" class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">From</label>
                            <input type="time" asp-for="NewException.StartTime" class="form-control" />
                            <span asp-validation-for="NewException.StartTime" class="text-danger"></span>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">To</label>
                            <input type="time" asp-for="NewException.EndTime" class="form-control" />
                            <span asp-validation-for="NewException.EndTime" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <input asp-for="NewException.Reason" class="form-control" placeholder="e.g. Vacation, Sick leave, Personal" />
                        <span asp-validation-for="NewException.Reason" class="text-danger"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Add Exception</button>
                </div>
            </form>
        </div>
    </div>
</div>

@*Modal delete schedule*@
<div class="modal fade" id="deleteScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="DeleteSchedule">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this schedule entry?</p>
                    <p class="text-danger small">This action cannot be undone.</p>

                    <input type="hidden" name="scheduleId" id="deleteScheduleIdInput" value="" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
@*Modal edit schedule*@
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="UpdateSchedule">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Work Hours</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                    <input type="hidden" name="id" id="editScheduleId" value="@ViewData["EditScheduleId"]" />

                    <input type="hidden" asp-for="UpdateSchedule.VetId" value="@Model.VetId" />

                    <div class="mb-3">
                        <label class="form-label">Day of Week</label>
                        <select asp-for="UpdateSchedule.DayOfWeek" class="form-select" id="editDayOfWeek"
                                asp-items="Model.WorkingDaysOptions">
                            <option value="">-- Select Day --</option>
                        </select>
                        <span asp-validation-for="UpdateSchedule.DayOfWeek" class="text-danger"></span>

                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">From</label>
                            <input type="time" asp-for="UpdateSchedule.StartTime" class="form-control" id="editStartTime"
                                   min="09:00" max="16:30" step="1800" />
                            <span asp-validation-for="UpdateSchedule.StartTime" class="text-danger"></span>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">To</label>
                            <input type="time" asp-for="UpdateSchedule.EndTime" class="form-control" id="editEndTime"
                                   min="09:00" max="16:30" step="1800" />
                            <span asp-validation-for="UpdateSchedule.EndTime" class="text-danger"></span>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
@*Modal delete exception*@
<div class="modal fade" id="deleteExceptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="DeleteException">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Exception</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this exception?</p>
                    <input type="hidden" name="exceptionId" id="deleteExceptionIdInput" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
@*Modal edit exception*@
<div class="modal fade" id="editExceptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="UpdateException">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Exception</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                    <input type="hidden" name="id" id="editExceptionId" value="@ViewData["EditScheduleId"]" />
                    <input type="hidden" asp-for="UpdateException.VetId" value="@Model.VetId" />

                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" asp-for="UpdateException.ExceptionDate" class="form-control" id="editExceptionDate" />
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" asp-for="UpdateException.IsFullDayAbsence" id="editIsFullDayCheck" />
                        <label class="form-check-label" for="editIsFullDayCheck">Full day off</label>
                    </div>

                    <div id="editTimeInputs" class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">From</label>
                            <input type="time" asp-for="UpdateException.StartTime" class="form-control" id="editExceptionStart" />
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">To</label>
                            <input type="time" asp-for="UpdateException.EndTime" class="form-control" id="editExceptionEnd" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <input asp-for="UpdateException.Reason" class="form-control" id="editExceptionReason" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        //hide time inputs when "Full day off" is checked
        document.getElementById('isFullDayCheck').addEventListener('change', function()
        {
            var timeInputs = document.getElementById('timeInputs');

            if(this.checked)
            {
                timeInputs.style.display = 'none';
            }
            else
            {
                timeInputs.style.display = 'flex';
            }
        });

        var editFullDayCheck = document.getElementById('editIsFullDayCheck');
        if (editFullDayCheck) 
        {
            editFullDayCheck.addEventListener('change', function() 
            {
                var timeInputs = document.getElementById('editTimeInputs');
                timeInputs.style.display = this.checked ? 'none' : 'flex';
            });
        }

        var deleteScheduleModal = document.getElementById('deleteScheduleModal');
        deleteScheduleModal.addEventListener('show.bs.modal', function (event)
        {

            var button = event.relatedTarget;

            var scheduleId = button.getAttribute('data-schedule-id');

            var input = document.getElementById('deleteScheduleIdInput');
            input.value = scheduleId;
        });

        var editScheduleModal = document.getElementById('editScheduleModal');
        editScheduleModal.addEventListener('show.bs.modal', function (event) 
        {
            var button = event.relatedTarget;

            var id = button.getAttribute('data-id');
            var day = button.getAttribute('data-day');
            var start = button.getAttribute('data-start');
            var end = button.getAttribute('data-end');

            document.getElementById('editScheduleId').value = id;
            document.getElementById('editDayOfWeek').value = day;
            document.getElementById('editStartTime').value = start;
            document.getElementById('editEndTime').value = end;
        });

        var deleteExceptionModal = document.getElementById('deleteExceptionModal');
        if (deleteExceptionModal) 
        {
            deleteExceptionModal.addEventListener('show.bs.modal', function (event) 
            {
                var button = event.relatedTarget;
                document.getElementById('deleteExceptionIdInput').value = button.getAttribute('data-exception-id');
            });
        }

        var editExceptionModal = document.getElementById('editExceptionModal');
        if (editExceptionModal) 
        {
            editExceptionModal.addEventListener('show.bs.modal', function (event) 
            {
                var button = event.relatedTarget;

                var id = button.getAttribute('data-id');
                var date = button.getAttribute('data-date');
                var isFullDay = button.getAttribute('data-isfullday') === 'true';
                var start = button.getAttribute('data-start');
                var end = button.getAttribute('data-end');
                var reason = button.getAttribute('data-reason');

                document.getElementById('editExceptionId').value = id;
                document.getElementById('editExceptionDate').value = date;
                document.getElementById('editExceptionReason').value = reason;

                var checkBox = document.getElementById('editIsFullDayCheck');
                checkBox.checked = isFullDay;

                var eventChange = new Event('change');
                checkBox.dispatchEvent(eventChange);

                document.getElementById('editExceptionStart').value = start;
                document.getElementById('editExceptionEnd').value = end;
            });
        }

    </script>
    @if (ViewData["OpenModal"] != null)
    {
        <script>
            document.addEventListener("DOMContentLoaded", function() 
            {
                var modalId = '@ViewData["OpenModal"]';
                var myModal = new bootstrap.Modal(document.getElementById(modalId));
                myModal.show();

                if (modalId === 'addExceptionModal') 
                {
                    var checkBox = document.getElementById('isFullDayCheck');
                    if (checkBox && checkBox.checked) 
                    {
                        checkBox.dispatchEvent(new Event('change'));
                    }
                }

                if (modalId === 'editExceptionModal') 
                {
                    var checkBox = document.getElementById('editIsFullDayCheck');
                    if (checkBox && checkBox.checked) 
                    {
                        checkBox.dispatchEvent(new Event('change'));
                    }
                }
            });
        </script>
    }
}