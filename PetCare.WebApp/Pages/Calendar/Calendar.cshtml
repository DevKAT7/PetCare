@page
@model PetCare.WebApp.Pages.CalendarModel
@using PetCare.Core.Enums
@{
    ViewData["Title"] = "Calendar";

    //helper format for date display
    var dateRangeStr = $"{Model.WeekDays.First():dd.MM.yyyy} - {Model.WeekDays.Last():dd.MM.yyyy}";

    //do mapowania statusu na klasę CSS -> w site.css
    string GetStatusClass(AppointmentStatus status)
    {
        return status switch
        {
            AppointmentStatus.Scheduled => "status-scheduled",
            AppointmentStatus.Confirmed => "status-scheduled",
            AppointmentStatus.Cancelled => "status-cancelled",
            AppointmentStatus.Completed => "status-completed",
            AppointmentStatus.NoShow => "status-noshow",
            _ => "status-default"
        };
    }
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Calendar</h2>
</div>

<div class="row mb-4 align-items-end">
    <div class="col-md-8">
        <form method="get" class="d-flex gap-3 align-items-center">
            <input type="hidden" name="CurrentDate" value="@Model.WeekDays.First().ToString("yyyy-MM-dd")" />

            <div class="d-flex align-items-center">
                <label class="me-2 fw-bold text-muted">Filter:</label>
                <select asp-for="SelectedVetId" asp-items="Model.VetOptions" class="form-select form-select-sm shadow-sm" style="width: 200px; border-radius: 20px;" onchange="this.form.submit()">
                    <option value="">All Veterinarians</option>
                </select>
            </div>

            <div class="bg-white p-1 rounded-pill shadow-sm d-flex align-items-center border">
                <a asp-page="./Calendar"
                   asp-route-CurrentDate="@Model.WeekDays.First().AddDays(-7).ToString("yyyy-MM-dd")"
                   asp-route-SelectedVetId="@Model.SelectedVetId"
                   class="btn btn-sm btn-light rounded-circle" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-chevron-left"></i>
                </a>

                <span class="fw-bold mx-3 text-primary">
                    <i class="bi bi-calendar-week me-2"></i> @dateRangeStr
                </span>

                <a asp-page="./Calendar"
                   asp-route-CurrentDate="@Model.WeekDays.First().AddDays(7).ToString("yyyy-MM-dd")"
                   asp-route-SelectedVetId="@Model.SelectedVetId"
                   class="btn btn-sm btn-light rounded-circle" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </form>
    </div>

    <div class="col-md-4 text-end">
        <small class="me-2"><span class="badge" style="background:#f3e5f5; color:#4a148c; border:1px solid #d1c4e9">Scheduled</span></small>
        <small class="me-2"><span class="badge" style="background:#ffebee; color:#b71c1c; border:1px solid #f44336">Cancelled</span></small>
        <small class="me-2"><span class="badge" style="background:#f5f5f5; color:#616161; border:1px solid #9e9e9e">Done</span></small>
        <small><span class="badge" style="background:#fff8e1; color:#8d6e63; border:1px solid #ffc107">No Show</span></small>
    </div>
</div>

<div class="calendar-container shadow-sm">
    <table class="calendar-table">
        <thead>
            <tr>
                <th class="time-col"><i class="bi bi-clock"></i></th>
                @foreach (var day in Model.WeekDays)
                {
                    bool isToday = day.Date == DateTime.Today;
                    <th class="@(isToday ? "bg-primary text-white" : "")">
                        <div class="fs-5">@day.ToString("dd.MM")</div>
                        <small class="text-uppercase @(isToday ? "text-white-50" : "text-muted")">@day.ToString("dddd", new System.Globalization.CultureInfo("en-US"))</small>
                    </th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var timeSlot in Model.TimeSlots)
            {
                <tr>
                    <td class="time-col">
                        @timeSlot.ToString(@"hh\:mm")
                    </td>

                    @foreach (var day in Model.WeekDays)
                    {
                        <td>
                            <div class="empty-slot">
                                @{
                                    var cellApps = Model.Appointments
                                    .Where(a => a.AppointmentDateTime.Date == day.Date
                                    && a.AppointmentDateTime.TimeOfDay == timeSlot)
                                    .ToList();
                                }

                                @foreach (var app in cellApps)
                                {
                                    <div class="app-card @GetStatusClass(app.Status)">
                                        <span class="vet-name">
                                            <i class="bi bi-person-badge"></i> dr @app.VetName
                                        </span>

                                        <div class="details">
                                            <div><strong>@app.PetName</strong> <span class="text-muted">(@app.OwnerName)</span></div>
                                            <div class="text-truncate">@app.ReasonForVisit</div>
                                        </div>

                                        <div class="clearfix">
                                            <a asp-page="/Appointments/EditAppointment"
                                               asp-route-id="@app.AppointmentId"
                                               asp-route-source="calendar"
                                               class="btn-view shadow-sm">
                                                Go <i class="bi bi-arrow-right-short"></i>
                                            </a>
                                        </div>
                                    </div>
                                }
                            </div>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>