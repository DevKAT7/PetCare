@page "/pets/add"
@using PetCare.Shared.Dtos
@using PetCare.MobileApp.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Logging 
@inject ILogger<AddPet> Logger
@attribute [Authorize]
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<div class="details-page pb-5">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-link text-dark p-0 me-3" @onclick="GoBack">
            <i class="bi bi-arrow-left fs-4"></i>
        </button>
        <h4 class="mb-0 fw-bold">Add New Pet</h4>
    </div>

    <div class="card border-0 shadow-sm p-4">
        <EditForm Model="@petModel" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger small mb-3" />

            <div class="mb-4 text-center">
                <div class="position-relative d-inline-block">
                    <div class="image-preview rounded-circle shadow-sm border overflow-hidden d-flex align-items-center justify-content-center bg-light" 
                         style="width: 120px; height: 120px;">
                        @if (!string.IsNullOrEmpty(imagePreview))
                        {
                            <img src="@imagePreview" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;" />
                        }
                        else
                        {
                            <i class="bi bi-camera fs-1 text-secondary"></i>
                        }
                    </div>
                    
                    <label class="btn btn-primary btn-sm rounded-circle position-absolute bottom-0 end-0 shadow-sm" 
                           style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-plus-lg text-white"></i>
                        <InputFile OnChange="HandleImageUpload" accept=".png,.jpg,.jpeg" hidden />
                    </label>
                </div>
                <div class="small text-muted mt-2">Tap + to add photo</div>
            </div>

            <div class="mb-3">
                <label class="form-label small text-muted fw-bold text-uppercase">Name</label>
                <InputText @bind-Value="petModel.Name" class="form-control" placeholder="Pet's name" />
            </div>

            <div class="mb-3">
                <label class="form-label small text-muted fw-bold text-uppercase">Species</label>
                <InputSelect @bind-Value="petModel.Species" class="form-select">
                    <option value="Dog">Dog 🐶</option>
                    <option value="Cat">Cat 🐱</option>
                    <option value="Rabbit">Rabbit 🐰</option>
                    <option value="Bird">Bird 🐦</option>
                    <option value="Other">Other 🐾</option>
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label small text-muted fw-bold text-uppercase">Breed</label>
                <InputText @bind-Value="petModel.Breed" class="form-control" placeholder="e.g. Golden Retriever" />
            </div>

            <div class="mb-3">
                <label class="form-label small text-muted fw-bold text-uppercase">Date of Birth</label>
                <InputDate @bind-Value="petModel.DateOfBirth" class="form-control" />
            </div>

            <div class="mb-4">
                <label class="form-label small text-muted fw-bold text-uppercase d-block">Gender</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="gender" id="male" autocomplete="off" 
                           checked="@(petModel.IsMale)" @onchange="@(() => petModel.IsMale = true)">
                    <label class="btn btn-outline-primary" for="male"><i class="bi bi-gender-male"></i> Male</label>

                    <input type="radio" class="btn-check" name="gender" id="female" autocomplete="off" 
                           checked="@(!petModel.IsMale)" @onchange="@(() => petModel.IsMale = false)">
                    <label class="btn btn-outline-danger" for="female"><i class="bi bi-gender-female"></i> Female</label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span> <span>Saving...</span>
                }
                else
                {
                    <span>Save Pet</span>
                }
            </button>
        </EditForm>
    </div>
</div>

@code {
    private PetCreateModel petModel = new() { DateOfBirth = DateTime.Today };
    
    private bool isSubmitting = false;
    private string? imagePreview;

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            try
            {
                var resizedFile = await file.RequestImageFileAsync("image/jpeg", 400, 400);
                
                var buffer = new byte[resizedFile.Size];
                await resizedFile.OpenReadStream().ReadAsync(buffer);
                
                var base64 = Convert.ToBase64String(buffer);
                var dataUrl = $"data:image/jpeg;base64,{base64}";

                imagePreview = dataUrl;
                petModel.ImageUrl = dataUrl; 
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to process image");
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var ownerIdClaim = user.FindFirst("PetOwnerId");

            if (ownerIdClaim != null && int.TryParse(ownerIdClaim.Value, out int id))
            {
                petModel.PetOwnerId = id;
                
                Logger.LogInformation("Submitting new pet: {Name}, Species: {Species}", petModel.Name, petModel.Species);

                await ApiService.AddPetAsync(petModel);
                
                Logger.LogInformation("Pet added successfully. Navigating to list.");
                Navigation.NavigateTo("/pets");
            }
            else
            {
                Logger.LogWarning("Failed to add pet: PetOwnerId not found in the token.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "An error occurred while adding the pet.");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/pets");
    }
}