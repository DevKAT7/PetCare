@page "/pets"
@using PetCare.MobileApp.Models.Pets
@using PetCare.MobileApp.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Logging
@inject ILogger<AddPet> Logger
@attribute [Authorize]
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<div class="d-flex justify-content-between align-items-center mb-3 pt-2">
    <h3 class="fw-bold mb-0">Your Pets</h3>
    <button class="btn btn-sm btn-primary rounded-circle" style="width: 40px; height: 40px;" @onclick="NavigateToAddPet">
        <i class="bi bi-plus-lg"></i>
    </button>
</div>

@if (isLoading)
{
    <div class="d-flex justify-content-center mt-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (pets == null || !pets.Any())
{
    <div class="text-center mt-5 text-muted">
        <i class="bi bi-emoji-frown display-1"></i>
        <p class="mt-3">You don't have any pets yet.</p>
        <button class="btn btn-primary mt-2" @onclick="NavigateToAddPet">Add your first one</button>
    </div>
}
else
{
    <div class="pets-container">
        @foreach (var pet in pets)
        {
            <div class="card-custom d-flex align-items-center mb-3" @onclick="() => NavigateToDetails(pet.PetId)">
                <div class="pet-avatar me-3">
                    @if (!string.IsNullOrEmpty(pet.ImageUrl))
                    {
                        <img src="@pet.ImageUrl" alt="@pet.Name" />
                    }
                    else
                    {
                        <div class="placeholder-icon">
                            @GetSpeciesIcon(pet.Species)
                        </div>
                    }
                </div>

                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <h5 class="fw-bold mb-1">@pet.Name</h5>
                        @if (pet.IsMale)
                        {
                            <i class="bi bi-gender-male text-primary"></i>
                        }
                        else
                        {
                            <i class="bi bi-gender-female text-danger"></i>
                        }
                    </div>
                    <p class="text-muted small mb-0">@pet.Species • @(pet.Breed ?? "Mixed breed")</p>
                    <p class="text-muted small mb-0">@pet.Age year(s) old</p>
                </div>

                <i class="bi bi-chevron-right text-muted ms-2"></i>
            </div>
        }
    </div>
}

@code {
    private List<PetReadModel> pets;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            var ownerIdClaim = user.FindFirst("PetOwnerId");

            int? myPetOwnerId = null;

            if (ownerIdClaim != null && int.TryParse(ownerIdClaim.Value, out int id))
            {
                myPetOwnerId = id;
            }

            pets = await ApiService.GetPetsAsync(myPetOwnerId);
        }
        catch (Exception ex)
        {
            Logger.LogError($"Error fetching pets: {ex.Message}");
            pets = new List<PetReadModel>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetSpeciesIcon(string species)
    {
        return species?.ToLower() switch
        {
            "pies" or "dog" => "🐶",
            "kot" or "cat" => "🐱",
            "królik" or "rabbit" => "🐰",
            "ptak" or "bird" => "🐦",
            _ => "🐾"
        };
    }

    private void NavigateToAddPet()
    {
        Navigation.NavigateTo("/pets/add");
    }

    private void NavigateToDetails(int petId)
    {
        Navigation.NavigateTo($"/pets/{petId}");
    }
}