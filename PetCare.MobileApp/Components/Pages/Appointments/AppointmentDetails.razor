@page "/appointments/{Id:int}"
@using Microsoft.Extensions.Logging
@using PetCare.MobileApp.Enums
@using PetCare.MobileApp.Models.Appointments
@using PetCare.MobileApp.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject ILogger<AppointmentDetails> Logger

<div class="details-page pb-5">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-link text-dark p-0 me-3" @onclick="GoBack">
            <i class="bi bi-arrow-left fs-4"></i>
        </button>
        <h4 class="mb-0 fw-bold">Appointment Details</h4>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center mt-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    }
    else if (appointment == null)
    {
        <div class="alert alert-danger">Could not load appointment details.</div>
    }
    else
    {
        <div class="card-custom">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h5 class="fw-bold mb-1">@appointment.PetName</h5>
                    <small class="text-muted">@appointment.PetSpecies</small>
                </div>
                <span class="badge @GetStatusBadgeClass(appointment.Status)">@appointment.Status</span>
            </div>

            <div class="border-bottom pb-3 mb-3">
                <div class="row g-3">
                    <div class="col-6">
                        <small class="text-muted d-block fw-bold text-uppercase">Date</small>
                        <div class="fw-bold">@appointment.AppointmentDateTime.ToString("dd MMM yyyy")</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block fw-bold text-uppercase">Time</small>
                        <div class="fw-bold">@appointment.AppointmentDateTime.ToString("HH:mm")</div>
                    </div>
                </div>
            </div>

            <div class="border-bottom pb-3 mb-3">
                <small class="text-muted d-block fw-bold text-uppercase mb-2">Veterinarian</small>
                <div class="d-flex align-items-center">
                    <i class="bi bi-person-badge me-2 text-primary"></i>
                    <div>
                        <div class="fw-bold">Dr. @appointment.VetName</div>
                    </div>
                </div>
            </div>

            <div class="border-bottom pb-3 mb-3">
                <small class="text-muted d-block fw-bold text-uppercase mb-2">Reason for Visit</small>
                <div class="fw-bold">@appointment.ReasonForVisit</div>
            </div>

            @if (!string.IsNullOrEmpty(appointment.Description))
            {
                <div class="border-bottom pb-3 mb-3">
                    <small class="text-muted d-block fw-bold text-uppercase mb-2">Description</small>
                    <div>@appointment.Description</div>
                </div>
            }

            @if (!string.IsNullOrEmpty(appointment.Diagnosis))
            {
                <div class="border-bottom pb-3 mb-3">
                    <small class="text-muted d-block fw-bold text-uppercase mb-2">Diagnosis</small>
                    <div>@appointment.Diagnosis</div>
                </div>
            }

            @if (!string.IsNullOrEmpty(appointment.Notes))
            {
                <div class="border-bottom pb-3 mb-3">
                    <small class="text-muted d-block fw-bold text-uppercase mb-2">Notes</small>
                    <div>@appointment.Notes</div>
                </div>
            }

            @if (appointment.Procedures != null && appointment.Procedures.Any())
            {
                <div class="border-bottom pb-3 mb-3">
                    <small class="text-muted d-block fw-bold text-uppercase mb-2">Procedures</small>
                    <div class="list-group list-group-flush">
                        @foreach (var proc in appointment.Procedures)
                        {
                            <div class="list-group-item px-0 py-2 border-0">
                                <div class="fw-bold small">@proc.ProcedureName</div>
                                <small class="text-muted d-block">@proc.FinalPrice.ToString("C")</small>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (appointment.InvoiceId.HasValue)
            {
                <div class="alert alert-info small mb-0">
                    <i class="bi bi-receipt me-2"></i>Invoice ID: @appointment.InvoiceId
                </div>
            }
        </div>

        @if (appointment.Status == AppointmentStatus.Scheduled)
        {
            <div class="d-grid pb-4 gap-2">
                @if (appointment.AppointmentDateTime > DateTime.Now.AddHours(2))
                {
                    <button class="btn btn-danger btn-lg shadow fw-bold" @onclick="CancelAppointment" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Cancelling...</span>
                        }
                        else
                        {
                            <span>Cancel Appointment</span>
                        }
                    </button>
                }
                else
                {
                    <button class="btn btn-secondary btn-lg shadow fw-bold" disabled
                            style="background-color: #e9ecef; border-color: #e9ecef; color: #6c757d;">
                        Too late to cancel
                    </button>
                    <small class="text-center text-muted">Cancellations are allowed up to 2 hours before the visit.</small>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private AppointmentReadModel? appointment;
    private bool isLoading = true;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            appointment = await ApiService.GetAppointmentDetailsAsync(Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load appointment details for id {Id}", Id);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CancelAppointment()
    {
        if (appointment == null) return;

        if (appointment.AppointmentDateTime <= DateTime.Now.AddHours(2))
        {
            await Application.Current.MainPage.DisplayAlert("Too Late", "You cannot cancel less than 2 hours before the visit.", "OK");
            return;
        }

        bool confirm = await Application.Current.MainPage.DisplayAlert(
            "Cancel Appointment",
            "Are you sure you want to cancel this visit?",
            "Yes, Cancel",
            "No");

        if (!confirm) return;

        isSubmitting = true;
        try
        {
            await ApiService.CancelAppointmentAsync(Id);
            await Application.Current.MainPage.DisplayAlert("Success", "Appointment cancelled.", "OK");
            Navigation.NavigateTo("/appointments");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cancelling appointment");
            await Application.Current.MainPage.DisplayAlert("Error", "Failed to cancel appointment.", "OK");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/appointments");
    }

    private string GetStatusBadgeClass(AppointmentStatus status)
    {
        return status switch
        {
            AppointmentStatus.Scheduled => "bg-primary-subtle text-custom-purple",
            AppointmentStatus.Confirmed => "bg-success-subtle text-success",
            AppointmentStatus.Completed => "bg-secondary-subtle text-secondary",
            AppointmentStatus.Cancelled => "bg-danger-subtle text-danger",
            AppointmentStatus.NoShow => "bg-dark-subtle text-dark",
            _ => "bg-light text-dark"
        };
    }
}
