@page "/register"
@layout LoginLayout
@using PetCare.MobileApp.Services
@using PetCare.Shared.Dtos
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inject IApiService ApiService
@inject NavigationManager Navigation

<div class="auth-card my-3">
    <div class="auth-header">
        <h3 class="auth-title">Create Account</h3>
        <p class="auth-subtitle">Join the PetCare family today</p>
    </div>

    <EditForm EditContext="@editContext" OnValidSubmit="HandleRegistration">
        <DataAnnotationsValidator />
        <CustomValidation @ref="customValidation" />

        <h6 class="text-uppercase text-muted small fw-bold mb-3 mt-2">Account Details</h6>
        
        <div class="auth-input-group">
            <span class="auth-input-icon"><i class="bi bi-envelope"></i></span>
            <InputText @bind-Value="registerModel.Email" class="form-control auth-input" placeholder="Email" />
        </div>
        <ValidationMessage For="@(() => registerModel.Email)" class="text-danger small" />

        <div class="auth-input-group mt-3">
            <span class="auth-input-icon"><i class="bi bi-lock"></i></span>
            <InputText @bind-Value="registerModel.Password" type="password" class="form-control auth-input" placeholder="Password" />
        </div>
        <ValidationMessage For="@(() => registerModel.Password)" class="text-danger small" />

        <div class="auth-input-group mt-3">
            <span class="auth-input-icon"><i class="bi bi-check-lg"></i></span> <InputText @bind-Value="registerModel.ConfirmPassword" 
            type="password" class="form-control auth-input" placeholder="Confirm Password" />
        </div>
        <ValidationMessage For="@(() => registerModel.ConfirmPassword)" class="text-danger small" />

        <h6 class="text-uppercase text-muted small fw-bold mb-3 mt-4">Personal Information</h6>

        <div class="row g-2">
            <div class="col-6">
                <div class="auth-input-group">
                    <span class="auth-input-icon"><i class="bi bi-person"></i></span>
                    <InputText @bind-Value="registerModel.FirstName" class="form-control auth-input" placeholder="First Name" />
                </div>
            </div>
            <div class="col-6">
                <div class="auth-input-group">
                    <InputText @bind-Value="registerModel.LastName" class="form-control auth-input px-3" placeholder="Last Name" />
                </div>
            </div>
        </div>
        <ValidationMessage For="@(() => registerModel.FirstName)" class="text-danger small" />
        <ValidationMessage For="@(() => registerModel.LastName)" class="text-danger small" />

        <div class="auth-input-group mt-2">
            <span class="auth-input-icon"><i class="bi bi-telephone"></i></span>
            <InputText @bind-Value="registerModel.PhoneNumber" class="form-control auth-input" placeholder="Phone Number" />
        </div>
        <ValidationMessage For="@(() => registerModel.PhoneNumber)" class="text-danger small" />

        <div class="auth-input-group mt-2">
            <span class="auth-input-icon"><i class="bi bi-geo-alt"></i></span>
            <InputTextArea @bind-Value="registerModel.Address" class="form-control auth-input" rows="1" placeholder="Address" style="resize: none; padding-top: 10px;" />
        </div>
        <ValidationMessage For="@(() => registerModel.Address)" class="text-danger small" />

        <button type="submit" class="btn btn-primary w-100 py-3 mt-4 fw-bold shadow-sm" style="border-radius: 12px;">
            Register
        </button>

        @if (!string.IsNullOrEmpty(globalError))
        {
            <div class="alert alert-danger mt-3 text-center small">@globalError</div>
        }

        <div class="text-center mt-3">
            <span class="text-muted">Already have an account?</span>
            <a href="login" class="auth-link ms-1">Log in</a>
        </div>
    </EditForm>
</div>


@code {
    private RegisterRequest registerModel = new();
    private EditContext? editContext;
    private CustomValidation? customValidation;
    private string? globalError;

    protected override void OnInitialized()
    {
        editContext = new EditContext(registerModel);
    }

    private async Task HandleRegistration()
    {
        customValidation?.ClearErrors();
        globalError = null;

        try
        {
            var response = await ApiService.PostAsync<RegisterRequest, AuthResponse>("api/auth/register", registerModel);

            if (response.Success)
            {
                Navigation.NavigateTo("/login");
            }
            else
            {
                if (response.ValidationErrors != null && response.ValidationErrors.Any())
                {
                    customValidation?.DisplayErrors(response.ValidationErrors);
                }
                else
                {
                    globalError = response.ErrorMessage ?? "Registration failed";
                }
            }
        }
        catch (Exception ex)
        {
            globalError = $"Connection error: {ex.Message}";
        }
    }
}